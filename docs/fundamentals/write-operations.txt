.. _laravel-fundamentals-write-ops:

================
Write Operations
================

.. facet::
   :name: genre
   :values: tutorial

.. meta::
   :keywords: insert, insert one, update, update one, upsert, delete, delete many, code example, mass assignment, eloquent model

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 2
   :class: singlecol

Overview
--------

In this guide, you can learn how to use {+odm-short+} to perform
**write operations** on your MongoDB collections. Write operations include
inserting, updating, and deleting data based on specified criteria.

This guide shows you how to perform the following tasks:

- :ref:`laravel-fundamentals-insert-documents`
- Modify Documents
- Delete Documents

.. _laravel-fundamentals-insert-documents:

Insert Documents
----------------

In this section, you can learn how to insert documents into MongoDB collections
from your Laravel application by using the {+odm-long+}.

When you insert the documents, ensure the data does not violate any
unique indexes on the collection. When inserting the first document of a
collection or creating a new collection, MongoDB automatically creates a
unique index on the ``_id`` field.

For more information on creating indexes on MongoDB collections by using the
Laravel schema builder, see the :ref:`laravel-eloquent-indexes` guide.

This section uses the following example model class to demonstrate how to
use Eloquent models to perform insert operations:

.. literalinclude:: /includes/fundamentals/write-operations/Concert.php
   :language: php
   :dedent:
   :caption: Concert.php

.. tip::

   The ``$fillable`` attribute lets you use Laravel mass assignment for insert
   operations. To learn more about mass assignment, see :ref:`laravel-model-mass-assignment`.

   The ``$casts`` attribute instructs Laravel to convert attributes to common
   data types. To learn more, see `Attribute Casting <https://laravel.com/docs/{+laravel-docs-version+}/eloquent-mutators#attribute-casting>`__
   in the Laravel documentation.

To learn more about Eloquent models in {+odm-short+} see the :ref:`laravel-eloquent-models`
section.

Insert a Document Examples
~~~~~~~~~~~~~~~~~~~~~~~~~~

These examples show how to use the ``save()`` Eloquent method to insert an
instance of a ``Concert`` model as a MongoDB document.

When the ``save()`` method succeeds, the instance on which you called the
method contains the model. If it fails, the instance is assigned a null value.

This example code performs the following actions:

- Creates a new instance of the ``Concert`` model
- Assigns string values to the ``performer`` and ``venue`` field
- Assigns a date to the ``performanceDate`` field by using the ``Carbon``
  package
- Inserts the document by calling the ``save()`` method

.. literalinclude:: /includes/fundamentals/write-operations/WriteOperationsTest.php
   :language: php
   :dedent:
   :start-after: begin model insert one
   :end-before: end model insert one

You can retrieve the inserted document's ``_id`` value by accessing the model's
``id`` member as shown in the following code example:

.. literalinclude:: /includes/fundamentals/write-operations/WriteOperationsTest.php
   :language: php
   :dedent:
   :start-after: begin inserted id
   :end-before: end inserted id

If you enable mass assignment by defining either the ``$fillable`` or
``$guarded`` attributes, you can use the Eloquent model ``create()`` method
to perform the insert in a single call as shown in the following example:

.. literalinclude:: /includes/fundamentals/write-operations/WriteOperationsTest.php
   :language: php
   :dedent:
   :start-after: begin model insert one mass assign
   :end-before: end model insert one mass assign

To learn more about the Carbon PHP API extension, see the
`Carbon <https://github.com/briannesbitt/Carbon>`__ GitHub repository.

Insert Multiple Documents Example
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

This example shows how to use the ``insert()`` Eloquent method to insert
multiple instances of a ``Concert`` model as MongoDB documents. This bulk
insert method reduces the number of calls your application needs to make
to save the documents.

When the ``insert()`` method succeeds, it returns the value ``1``. If it
fails, it throws an exception.

The example code saves multiple models in a single call by passing them as
an array to ``insert()`` method:

.. note::

    This example wraps the dates in the `MongoDB\BSON\UTCDateTime <{+phplib-api+}/class.mongodb-bson-utcdatetime.php>`__
    class to convert it to a type MongoDB can serialize because Laravel
    skips attribute casting on bulk insert operations.

.. literalinclude:: /includes/fundamentals/write-operations/WriteOperationsTest.php
   :language: php
   :dedent:
   :start-after: begin model insert many
   :end-before: end model insert many

